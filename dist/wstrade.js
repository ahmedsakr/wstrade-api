!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("node-fetch"),require("http-status")):"function"==typeof define&&define.amd?define(["node-fetch","http-status"],t):"object"==typeof exports?exports["wstrade-api"]=t(require("node-fetch"),require("http-status")):e["wstrade-api"]=t(e._,e._)}(global,(function(e,t){return(()=>{"use strict";var s={661:(e,t,s)=>{s.r(t),s.d(t,{default:()=>I});var r=s(545),a=s.n(r),o=s(457),i=s.n(o);let n=new r.Headers;const c={add:(e,t)=>n.append(e,t),remove:e=>n.delete(e),clear:()=>[...n].forEach((e=>n.delete(e[0]))),values:()=>[...n]};async function u(e,t){try{const s=await function(e,t){let s=new(a().Headers);s.append("Content-Type","application/json"),m.tokens&&s.append("Authorization",m.tokens.access),c.values().forEach((e=>s.append(...e)));let{url:r,payload:o}=function(e,t){t=Object.assign({},t);let s=e.url;if(e.parameters)for(let r=0;r<Object.keys(e.parameters).length;r++){if(null===t[e.parameters[r]]||void 0===t[e.parameters[r]])throw new Error("URL Path parameter missing");s=s.replace(`{${r}}`,t[e.parameters[r]]),delete t[e.parameters[r]]}return["GET","HEAD"].includes(e.method)?{url:s,payload:void 0}:{url:s,payload:JSON.stringify(t)}}(e,t);return a()(r,{body:o,method:e.method,headers:s})}(e,t);return[i().OK,i().CREATED].includes(s.status)?e.onSuccess({arguments:t,response:s}):Promise.reject(await e.onFailure(s))}catch(e){throw e}}const l=["NASDAQ","NYSE","TSX","TSX-V"],d=class{constructor(e){if(this.symbol=null,this.exchange=null,this.id=null,"string"==typeof e){let t=e.split(":");this.symbol=t[0],this.exchange=t[1]}else{if(!e.hasOwnProperty("symbol")&&!e.hasOwnProperty("id"))throw new Error(`Invalid ticker '${e}'`);this.symbol=e.symbol,this.exchange=e.exchange,this.id=e.id}if(this.exchange&&!l.includes(this.exchange))throw new Error(`Invalid exchange '${this.exchange}'!`)}format(){return this.id?this.id:`${this.symbol}${this.exchange?":"+this.exchange:""}`}weakEquals(e){return this.id===e.id||this.symbol===e.symbol}},p={onFailure:async e=>({status:e.status,reason:e.statusText,body:await e.json()}),onSuccess:async e=>await e.response.json()},h={LOGIN:{method:"POST",url:"https://trade-service.wealthsimple.com/auth/login",onSuccess:async e=>({tokens:{access:e.response.headers.get("x-access-token"),refresh:e.response.headers.get("x-refresh-token")},accountInfo:await e.response.json()}),onFailure:p.onFailure},REFRESH:{method:"POST",url:"https://trade-service.wealthsimple.com/auth/refresh",onSuccess:async e=>({access:e.response.headers.get("x-access-token"),refresh:e.response.headers.get("x-refresh-token")}),onFailure:p.onFailure},ACCOUNT_IDS:{method:"GET",url:"https://trade-service.wealthsimple.com/account/list",onSuccess:async e=>(await e.response.json()).results.map((e=>e.id)),onFailure:p.onFailure},LIST_ACCOUNT:{method:"GET",url:"https://trade-service.wealthsimple.com/account/list",onSuccess:p.onSuccess,onFailure:p.onFailure},ME:{method:"GET",url:"https://trade-service.wealthsimple.com/me",onSuccess:p.onSuccess,onFailure:p.onFailure},PERSON:{method:"GET",url:"https://trade-service.wealthsimple.com/person",onSuccess:p.onSuccess,onFailure:p.onFailure},HISTORY_ACCOUNT:{method:"GET",url:"https://trade-service.wealthsimple.com/account/history/{0}?account_id={1}",parameters:{0:"interval",1:"accountId"},onSuccess:p.onSuccess,onFailure:p.onFailure},ACTIVITIES:{method:"GET",url:"https://trade-service.wealthsimple.com/account/activities",onSuccess:async e=>(await e.response.json()).results,onFailure:p.onFailure},DEPOSITS:{method:"GET",url:"https://trade-service.wealthsimple.com/deposits",onSuccess:async e=>(await e.response.json()).results,onFailure:p.onFailure},BANK_ACCOUNTS:{method:"GET",url:"https://trade-service.wealthsimple.com/bank-accounts",onSuccess:async e=>(await e.response.json()).results,onFailure:p.onFailure},EXCHANGE_RATES:{method:"GET",url:"https://trade-service.wealthsimple.com/forex",onSuccess:p.onSuccess,onFailure:p.onFailure},SECURITY:{method:"GET",url:"https://trade-service.wealthsimple.com/securities?query={0}",parameters:{0:"ticker"},onSuccess:async e=>{let t=await e.response.json();return 0===t.results.length?Promise.reject({reason:"Security does not exist"}):t.results},onFailure:p.onFailure},EXTENSIVE_SECURITY_DETAILS:{method:"GET",url:"https://trade-service.wealthsimple.com/securities/{0}",parameters:{0:"id"},onSuccess:async e=>await e.response.json(),onFailure:p.onFailure},POSITIONS:{method:"GET",url:"https://trade-service.wealthsimple.com/account/positions?account_id={0}",parameters:{0:"accountId"},onSuccess:async e=>(await e.response.json()).results,onFailure:p.onFailure},ORDERS_BY_PAGE:{method:"GET",url:"https://trade-service.wealthsimple.com/orders?offset={0}&account_id={1}",parameters:{0:"offset",1:"accountId"},onSuccess:async e=>{const t=await e.response.json();return{total:t.total,orders:t.results}},onFailure:p.onFailure},ALL_ORDERS:{method:"GET",url:"https://trade-service.wealthsimple.com/orders?account_id={0}",parameters:{0:"accountId"},onSuccess:async e=>{const t=await e.response.json(),s=Math.ceil(t.total/20);let r=t.results;if(s>1)for(let t=2;t<=s;t++){let s=await I.orders.page(e.arguments.accountId,t);r.push(...s.orders)}return{total:r.length,orders:r}},onFailure:p.onFailure},FILTERED_ORDERS:{method:"GET",url:"https://trade-service.wealthsimple.com/orders?account_id={0}",parameters:{0:"accountId"},onSuccess:async e=>{const t=await e.response.json(),s=Math.ceil(t.total/20);let r=t=>{let s=e.arguments.ticker;if(s){let e=new d({symbol:t.symbol,id:t.security_id});if(!s.weakEquals(e))return!1}return t.status===e.arguments.status},a=t.results.filter(r);if(s>1)for(let t=2;t<=s;t++){let s=await I.orders.page(e.arguments.accountId,t);a.push(...s.orders.filter(r))}return{total:a.length,orders:a}},onFailure:p.onFailure},CANCEL_ORDER:{method:"DELETE",url:"https://trade-service.wealthsimple.com/orders/{0}",parameters:{0:"orderId"},onSuccess:async e=>({order:e.arguments.orderId,response:await e.response.json()}),onFailure:p.onFailure},PLACE_ORDER:{method:"POST",url:"https://trade-service.wealthsimple.com/orders",onSuccess:p.onSuccess,onFailure:p.onFailure}},m={tokens:null,otp:null,on:function(e,t){this[e]=t},login:async function(e,t){let s=null;"function"==typeof this.otp&&await u(h.LOGIN,{email:e,password:t}).catch((()=>{}));try{s=await u(h.LOGIN,{email:e,password:t,otp:"function"==typeof this.otp?await this.otp():this.otp})}catch(e){if(!this.otp)return Promise.reject("OTP not provided!");throw e}this.tokens=s.tokens},refresh:async function(){let e=await u(h.REFRESH,{refresh_token:this.tokens.refresh});this.tokens=e.tokens}},y={all:async()=>{let e=await u(h.ACCOUNT_IDS,{});return{tfsa:e.find((e=>e.startsWith("tfsa"))),rrsp:e.find((e=>e.startsWith("rrsp"))),crypto:e.find((e=>e.startsWith("non-registered-crypto"))),personal:e.find((e=>e.startsWith("non-registered")&&!e.startsWith("non-registered-crypto")))}},data:async()=>u(h.LIST_ACCOUNT,{}),me:async()=>u(h.ME,{}),person:async()=>u(h.PERSON,{}),history:async(e,t)=>u(h.HISTORY_ACCOUNT,{interval:e,accountId:t}),activities:async()=>u(h.ACTIVITIES,{}),getBankAccounts:async()=>u(h.BANK_ACCOUNTS,{}),deposits:async()=>u(h.DEPOSITS,{}),positions:async e=>u(h.POSITIONS,{accountId:e})},_=async(e,t,s)=>u(h.FILTERED_ORDERS,{accountId:e,ticker:new d(t),status:s}),S={page:async(e,t)=>u(h.ORDERS_BY_PAGE,{offset:20*(t-1),accountId:e}),all:async e=>u(h.ALL_ORDERS,{offset:0,accountId:e}),pending:async(e,t)=>_(e,t,"submitted"),filled:async(e,t)=>_(accountID,t,"posted"),cancelled:async(e,t)=>_(e,t,"cancelled")},f={exchangeRates:async()=>u(h.EXCHANGE_RATES,{}),getSecurity:async(e,t)=>{if((e=new d(e)).id)return u(h.EXTENSIVE_SECURITY_DETAILS,{id:e.id});let s=await u(h.SECURITY,{ticker:e.symbol});return s=s.filter((t=>t.stock.symbol===e.symbol)),e.exchange&&(s=s.filter((t=>t.stock.primary_exchange===e.exchange))),s.length>1?Promise.reject({reason:"Multiple securities matched query."}):0===s.length?Promise.reject({reason:"No securities matched query."}):t?u(h.EXTENSIVE_SECURITY_DETAILS,{id:s[0].id}):s[0]}},E={default:{quote:async e=>(await f.getSecurity(e,!0)).quote.amount},providers:{},use:function(e,t){if("function"!=typeof t.quote)throw new Error(`Invalid quote provider for ${e}!`);this.providers[e]=t},get:async function(e){let t=(await f.getSecurity(e,!1)).stock.primary_exchange;return this.providers.hasOwnProperty(t)?this.providers[t].quote(e):this.default.quote(e)}},w=e=>["TSX","TSX-V"].includes(e),T={cancel:async e=>u(h.CANCEL_ORDER,{orderId:e}),cancelPending:async function(e){const t=await S.pending(e);return Promise.all(t.orders.map((async e=>await this.cancel(e.order_id))))},marketBuy:async(e,t,s)=>{let r=await f.getSecurity(t,!0);return u(h.PLACE_ORDER,{security_id:r.id,limit_price:await E.get(t),quantity:s,order_type:"buy_quantity",order_sub_type:"market",time_in_force:"day",account_id:e})},limitBuy:async(e,t,s,r)=>u(h.PLACE_ORDER,{security_id:(await f.getSecurity(t)).id,limit_price:s,quantity:r,order_type:"buy_quantity",order_sub_type:"limit",time_in_force:"day",account_id:e}),stopLimitBuy:async(e,t,s,r,a)=>{let o=await f.getSecurity(t);return w(o.stock.primary_exchange)&&s!==r?Promise.reject({reason:"TSX/TSX-V securities must have an equivalent stop and limit price."}):u(h.PLACE_ORDER,{security_id:o.id,stop_price:s,limit_price:r,quantity:a,order_type:"buy_quantity",order_sub_type:"stop_limit",time_in_force:"day",account_id:e})},marketSell:async(e,t,s)=>{let r=await f.getSecurity(t,!0);return u(h.PLACE_ORDER,{security_id:r.id,market_value:await E.get(t),quantity:s,order_type:"sell_quantity",order_sub_type:"market",time_in_force:"day",account_id:e})},limitSell:async(e,t,s,r)=>u(h.PLACE_ORDER,{security_id:(await f.getSecurity(t)).id,limit_price:s,quantity:r,order_type:"sell_quantity",order_sub_type:"limit",time_in_force:"day",account_id:e}),stopLimitSell:async(e,t,s,r,a)=>{let o=await f.getSecurity(t);return w(o.stock.primary_exchange)&&s!==r?Promise.reject({reason:"TSX/TSX-V securities must have an equivalent stop and limit price."}):u(h.PLACE_ORDER,{security_id:o.id,stop_price:s,limit_price:r,quantity:a,order_type:"sell_quantity",order_sub_type:"stop_limit",time_in_force:"day",account_id:e})}},g={...S,...T},I={auth:m,headers:c,accounts:y,orders:g,quotes:E,data:f}},457:e=>{e.exports=t},545:t=>{t.exports=e}},r={};function a(e){if(r[e])return r[e].exports;var t=r[e]={exports:{}};return s[e](t,t.exports,a),t.exports}return a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a(661)})()}));